---
- name: Monitor system utilization and send webhook if thresholds are exceeded
  hosts: all
  gather_facts: no
  ignore_unreachable: yes
  tasks:
    - name: Check CPU utilization
      shell: "top -bn1 | grep 'Cpu(s)' | awk '{print $2 + $4}'"
      register: cpu_utilization

    - name: Check memory utilization
      shell: "free | grep Mem | awk '{print $3/$2 * 100.0}'"
      register: memory_utilization

    - name: Check disk utilization
      shell: "df -h / | grep / | awk '{print $5}' | sed 's/%//g'"
      register: disk_utilization

    - name: Show Message
      debug:
        msg: "Here is the System Utilization: CPU: {{ cpu_utilization.stdout }}%, Memory: {{ memory_utilization.stdout }}%, Disk: {{ disk_utilization.stdout }}%"
      when: cpu_utilization.stdout | float > 80 or memory_utilization.stdout | float > 80 or disk_utilization.stdout | int > 80
      register: utilization_message